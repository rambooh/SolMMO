<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modular MMO - MVP</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Courier New', monospace;
        }
        
        body {
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            background: #2a2a2a;
            color: white;
        }
        
        #loginScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        h1 {
            font-size: 2.5em;
            margin-bottom: 20px;
            color: white;
        }
        
        button {
            padding: 12px 24px;
            margin: 10px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        #serverScreen {
            display: none; /* Removed - no longer used */
        }
        
        .server-item {
            display: block;
            width: 100%;
            margin: 10px 0;
            padding: 15px;
            text-align: left;
        }
        
        .server-item.selected {
            background: rgba(78, 205, 196, 0.3);
        }
        
        #gameCanvas {
            display: none;
            background: #47aba9;
        }
        
        #gameUI {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
            display: none;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen">
        <div class="card">
            <h1>Modular MMO</h1>
            <p>MVP - Movement Only</p>
            
            <div>
                <button onclick="connectWallet('local')">üåê Connect Wallet</button>
            </div>
            
            <div id="walletInfo" style="margin-top: 20px; display: none;">
                <p>Connected: <span id="walletAddress"></span></p>
                <button onclick="joinServer()">Enter Game</button>
            </div>
        </div>
    </div>

    <!-- Server Selection - REMOVED -->

    <!-- Game -->
    <canvas id="gameCanvas"></canvas>
    <div id="gameUI">
        <div>Server: <span id="serverInfo">-</span></div>
        <div>Players: <span id="playerCount">1</span></div>
        <div>Use WASD or Arrow Keys to move</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.73.3/lib/index.iife.min.js"></script>
    <script>
        // === GAME STATE ===
        let gameState = {
            wallet: null,
            walletAddress: null,
            selectedServer: null,
            socket: null,
            isConnected: false,
            players: new Map(),
            myPlayer: { x: 400, y: 300 }
        };

        // === CONFIG ===
        const config = {
            playerSize: 32,
            playerSpeed: 4,
            serverUrl: 'wss://solmmo.onrender.com'
        };

        // === WALLET FUNCTIONS ===
        async function connectWallet(type) {
            try {
                // Always use local wallet for simplicity
                const keypair = solanaWeb3.Keypair.generate();
                const address = keypair.publicKey.toString();
                
                gameState.walletAddress = address;
                document.getElementById('walletAddress').textContent = 
                    address.slice(0, 4) + '...' + address.slice(-4);
                document.getElementById('walletInfo').style.display = 'block';
                
            } catch (error) {
                alert('Wallet connection failed: ' + error.message);
            }
        }

        // === SERVER CONNECTION ===
        async function joinServer() {
            try {
                gameState.socket = new WebSocket(config.serverUrl);
                
                gameState.socket.onopen = () => {
                    gameState.isConnected = true;
                    
                    // Send join message
                    send({
                        type: 'join',
                        playerId: gameState.walletAddress,
                        x: gameState.myPlayer.x,
                        y: gameState.myPlayer.y
                    });
                    
                    startGame();
                };
                
                gameState.socket.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    handleServerMessage(data);
                };
                
                gameState.socket.onclose = () => {
                    gameState.isConnected = false;
                    alert('Disconnected from server');
                };
                
            } catch (error) {
                alert('Failed to connect: ' + error.message);
            }
        }

        // === NETWORK ===
        function send(data) {
            if (gameState.socket && gameState.socket.readyState === WebSocket.OPEN) {
                gameState.socket.send(JSON.stringify(data));
            }
        }

        function handleServerMessage(data) {
            switch (data.type) {
                case 'existingPlayers':
                    // Load all existing players when joining
                    data.players.forEach(playerData => {
                        gameState.players.set(playerData.playerId, {
                            x: playerData.x,
                            y: playerData.y,
                            color: playerData.color
                        });
                    });
                    updatePlayerCount();
                    console.log(`Loaded ${data.players.length} existing players`);
                    break;
                    
                case 'playerJoined':
                    gameState.players.set(data.playerId, {
                        x: data.x,
                        y: data.y,
                        color: data.color || '#4ecdc4'
                    });
                    updatePlayerCount();
                    break;
                    
                case 'playerMoved':
                    if (gameState.players.has(data.playerId)) {
                        gameState.players.get(data.playerId).x = data.x;
                        gameState.players.get(data.playerId).y = data.y;
                    }
                    break;
                    
                case 'playerLeft':
                    gameState.players.delete(data.playerId);
                    updatePlayerCount();
                    break;
            }
        }

        function updatePlayerCount() {
            document.getElementById('playerCount').textContent = gameState.players.size + 1;
        }

        // === GAME LOGIC ===
        let keys = {};
        let canvas, ctx;
        let lastTime = 0;

        function startGame() {
            // Hide login screen
            document.getElementById('loginScreen').style.display = 'none';
            
            // Show game
            document.getElementById('gameCanvas').style.display = 'block';
            document.getElementById('gameUI').style.display = 'block';
            document.getElementById('serverInfo').textContent = 'SolMMO Server';
            
            // Setup canvas
            canvas = document.getElementById('gameCanvas');
            ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            // Input handling
            window.addEventListener('keydown', (e) => keys[e.key] = true);
            window.addEventListener('keyup', (e) => keys[e.key] = false);
            
            // Start game loop with timestamp
            lastTime = performance.now();
            gameLoop(lastTime);
        }

        function gameLoop(currentTime) {
            const deltaTime = (currentTime - lastTime) / 1000; // Convert to seconds
            lastTime = currentTime;
            
            update(deltaTime);
            render();
            requestAnimationFrame(gameLoop);
        }

        function update(deltaTime) {
            let moved = false;
            const oldX = gameState.myPlayer.x;
            const oldY = gameState.myPlayer.y;
            
            // Movement with delta time (pixels per second, not per frame)
            const moveSpeed = config.playerSpeed * 60; // 240 pixels per second
            
            if (keys['ArrowUp'] || keys['w'] || keys['W']) {
                gameState.myPlayer.y = Math.max(config.playerSize/2, gameState.myPlayer.y - moveSpeed * deltaTime);
                moved = true;
            }
            if (keys['ArrowDown'] || keys['s'] || keys['S']) {
                gameState.myPlayer.y = Math.min(canvas.height - config.playerSize/2, gameState.myPlayer.y + moveSpeed * deltaTime);
                moved = true;
            }
            if (keys['ArrowLeft'] || keys['a'] || keys['A']) {
                gameState.myPlayer.x = Math.max(config.playerSize/2, gameState.myPlayer.x - moveSpeed * deltaTime);
                moved = true;
            }
            if (keys['ArrowRight'] || keys['d'] || keys['D']) {
                gameState.myPlayer.x = Math.min(canvas.width - config.playerSize/2, gameState.myPlayer.x + moveSpeed * deltaTime);
                moved = true;
            }
            
            // Send movement to server
            if (moved && gameState.isConnected) {
                send({
                    type: 'move',
                    x: gameState.myPlayer.x,
                    y: gameState.myPlayer.y
                });
            }
        }

        function render() {
            // Clear canvas
            ctx.fillStyle = '#47aba9';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Setup emoji rendering
            ctx.font = '24px Arial';
            ctx.textAlign = 'center';
            
            // Draw other players as different emojis
            const playerEmojis = ['üê∏', 'ü¶Ñ', 'üêâ', 'üëΩ', 'ü§ñ', 'üëæ'];
            let emojiIndex = 0;
            
            gameState.players.forEach(player => {
                const emoji = playerEmojis[emojiIndex % playerEmojis.length];
                ctx.fillText(emoji, player.x, player.y + 8);
                emojiIndex++;
            });
            
            // Draw my player as a red wizard
            ctx.fillText('üî•', gameState.myPlayer.x, gameState.myPlayer.y + 8);
        }

        // === REMOVED SCREEN NAVIGATION ===
        // Everything goes directly from login to game now
    </script>
</body>
</html>
